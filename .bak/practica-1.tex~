% File              : practica-1.tex
% Author            : David Barcene <david.barcene@utp.ac.pa>
% Date              : 20.02.2026
% Last Modified Date: 24.02.2026
% Last Modified By  : David Barcene <david.barcene@utp.ac.pa>

\documentclass[letter]{article}

\usepackage{geometry}
\geometry{margin=1.5in}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage[spanish]{babel}
\usepackage{mathrsfs, amsmath, amssymb}
\usepackage[hidelinks]{hyperref}
\usepackage[backend=biber, style=apa]{biblatex}
\addbibresource{/home/dbarcene/Documents/bibliography/ref.bib}


% figure support
\usepackage{graphicx}
\graphicspath{ {./figures/} }
\usepackage{import}
\usepackage{xifthen}
\usepackage{pdfpages}
\usepackage{transparent}
\newcommand{\incfig}[1]{%
	\def\svgwidth{\columnwidth}
	\import{./figures/}{#1.pdf_tex}
}

% Extra packages
\usepackage{listings}

\lstset{
	basicstyle=\ttfamily\small,
	columns=flexible,
	keepspaces=true,
	literate={|--}{|--}1 {|____}{|____}5 {|}{|}1, % Optional: helps spacing
	breaklines=true,
	extendedchars=true
}


\begin{document}
\title{Práctica - \textit{Slurm, BWA}}
\author{David Barcene \ \href{mailto:david.barcene@utp.ac.pa}{david.barcene@utp.ac.pa}}
\date\today

\maketitle

\textbf{Objetivo:} Ejecutar el programa \textit{BWA} con un set de datos reales 
reproduciendo los resultados, para poder entender como se ejecutan los comandos
con \textit{Slurm}.

\section{Directorios}

El directorio rincipal \textbf{\~{}/data} consta de 3 subdirectorios:
\begin{itemize}
	\item\textbf{reads}: Datos de seccuenciación, 12 muestras en sus
		correspondientes archivos.
	\item\textbf{ref}: Genomas de referencia indexados.
	\item \textbf{BAM}: directorio output
\end{itemize}

\section{Procedimiento}
\begin{enumerate}
	\item Ejecutar el programa \textbf{BWA} para alinear la muestra al genoma de
	referencia.f En cada paso reemplazar la palabra "muestra" con el nombre de la
	muestra (ej. \textbf{BAL\_C1\_3h}, \textbf{BAL\_C2\_3h}, etc.).
	\begin{lstlisting}
		bwa mem -t 30 -o BAM/BAL_C1_3h_LpmP.sam \
		ref/LpmP_2025_union.fasta \
		reads/muestra_1.fq \
		reads/muestra_2.fq 
	\end{lstlisting}
	\item Ejecutar el programa \textbf{samtools} en tres pasos para generar
		un fichero binario de alineamiento en formato \textbf{BAM}
	\begin{lstlisting}
		# Paso 1: view
		samtools view -b -@ 30 \
		-o BAM/BAL_C1_3h_LpmP_unsorted.bam\
		BAM/BAL_C1_3h_LpmP.sam

		# Paso 2: sort
		samtools sort -b -@ 30 \
		-o BAM/BAL_C1_3h_LpmP.bam\
		BAM/BAL_C1_3h_LpmP_unsorted.sam

		# Paso 3: index
		samtools index BAM/BAL_C1_3h_LpmP.bam
	\end{lstlisting}
	\item Ejecutar el programa \textbf{samtools} nuevamente para guardar las
		estadísticas de alineamiento
	\begin{lstlisting}
		samtools flagstat -@ 30 BAM/BAL_C1_3h_LpmP,bam >
		muestra_stats.txt
	\end{lstlisting}
\end{enumerate}

\textbf{Nota}: Las opciones \textbf{bwa -t} y \textbf{samtools -$@$} indican el
número de núcleos. Este debe coincidir con el que se le solicite a Slurm via
\textbf{\#SBATCH --cpus-per-task}. El máximo numero de núcleos por nodo es
40.\\


\pagebreak
\begin{lstlisting}[caption={Directory Tree}]
data
|____BAM
|____ref
| |____LpmP_2025_union.fasta
| |____LpmP_2025_union.fasta.amb
| |____LpmP_2025_union.fasta.ann
| |____LpmP_2025_union.fasta.bwt
| |____LpmP_2025_union.fasta.pac
| |____LpmP_2025_union.fasta.sa
|____reads
| |____BAL_C1_3h_1.fq
| |____BAL_C1_3h_2.fq
| |____BAL_C2_3h_1.fq
| |____BAL_C2_3h_2.fq
| |____BAL_C3_3h_1.fq
| |____BAL_C3_3h_2.fq
| |____BAL_I1_3h_1.fq
| |____BAL_I1_3h_2.fq
| |____BAL_I2_3h_1.fq
| |____BAL_I2_3h_2.fq
| |____BAL_I3_3h_1.fq
| |____BAL_I3_3h_2.fq
| |____BL6_C1_3h_1.fq
| |____BL6_C1_3h_2.fq
| |____BL6_C2_3h_1.fq
| |____BL6_C2_3h_2.fq
| |____BL6_C3_3h_1.fq
| |____BL6_C3_3h_2.fq
| |____BL6_I1_3h_1.fq
| |____BL6_I1_3h_2.fq
| |____BL6_I2_3h_1.fq
| |____BL6_I2_3h_2.fq
| |____BL6_I3_3h_1.fq
| |____BL6_I3_3h_2.fq
\end{lstlisting}	

\section{Resultados}
Inicialmente se redactaron tres scripts para ejecutar 3 pasos de procesamiento
sobre todas las muestras de forma secuencial sobre un solo nodo. Esta solución
implica que se debe esperar a que se ejecuten todos los pasos sobre una sola
muestra para poder continuar con la siguiente.

\subsection{Paralelización}
Se redactaron dos scripts, el primero llamado \textbf{sample\_proc.sh} que
contiene todos los pasos para el tratamiento de una sola muestra en un solo
nodo. En este script se colocan los comentarios \textbf{\#SBATCH} luego del
shebang y los programas \textbf{bwa} y \textbf{samtools} se corren utilizando el
comando \textbf{srun} de \textbf{SLURM} para que sean gestionados.

Y un segundo script \textbf{run\_sbatch.sh} en el cual se corre el comando
\textbf{sbatch} de \textbf{SLURM} llamando al script \textbf{sample\_proc.sh}
dentro de un ciclo \textbf{for} que corre sobre cada muestra en el directorio \textbf{reads}.



\printbibliography

\end{document}
